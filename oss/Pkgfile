# Description: Open Sound System UNIX audio architecture.
# URL:         http://developer.opensound.com/
# Packager:    onodera, onodera at openmailbox dot org
# Maintainer:  6c37 Team, https://github.com/6c37/crux-ports-git/issues
# Depends on:  gtk

name=oss
version=git
release=2
source=(
	linux-4.0.patch
	kmod-link.patch
	ossvermagic.patch
	remove-hal.patch
	rm-init-scripts.patch
	soundon.patch
)

build () {
	cd $PKGMK_SOURCE_DIR

	if cd $name; then
		git fetch -q; git reset --hard origin/master
	else
		git clone git://git.code.sourceforge.net/p/opensound/git $name
		cd $name
	fi

	rm -rf build
	mkdir build

	patch -p1 < $SRC/linux-4.0.patch
	patch -p0 < $SRC/ossvermagic.patch

	cd setup/Linux
	patch -p2 < $SRC/rm-init-scripts.patch
	rm oss/etc/S89oss
	patch -p2 < $SRC/remove-hal.patch
	rm oss/scripts/*oss_usb-create-device*
	patch -p1 < $SRC/soundon.patch

	mv oss/build/{osscore.c,osscore_wrapper.c}
	patch -p2 < $SRC/kmod-link.patch
	cd ../..

	cd build
	../configure --enable-libsalsa=NO --config-midi=NO --regparm
	make build
	gcc $CFLAGS -shared -fPIC -Wall -Werror oss/lib/flashsupport.c -o libflashsupport.so

	make DESTDIR=$PKG/ copy
	install -Dm755 libflashsupport.so $PKG/usr/lib/oss/lib/libflashsupport.so

	cd $PKG
	chmod -R a+rX .
}
